let NengeApp=new class{version=7.2;CoreFile="wasm/vbanext-wasm.7z";Core7z="js/extract7z.min.js";CoreZip="js/jszip.js";CoreRar="js/libunrar.js";CoreRarMem="js/libunrar.js.mem";CoreDB="js/dexie.worker.js";CONFIG={stateKey:0,"do-music":!1};Timer={};CoreFileName=this.CoreFile.split("/").pop();constructor(){this.setConfig({}),this.CONFIG["do-record"]=!1,this.initDB()}DB=new class{info="INFO";room="ROOMS";state="STATE";DATA={DBNAME:"NengeNet_VBA-Next",STORES:{INFO:"&name,*time",ROOMS:"&name",STATE:"&name"}};constructor(t){return this.file=t.CoreDB,this.DATA.version=Math.floor(t.version),t=>new Promise(((e,s)=>((t=t||{}).db||(t.db="room"),t.db=this[t.db]||t.db,t.method||(t.method="get"),t.method=t.method.toLowerCase(),t.key=Math.random(),this.OPEN(t,e,s))))}SETPOST(t){for(let e in this.DATA)t[e]=this.DATA[e];return t}E={};OPEN(t,e,s){t&&(this.worker||(this.worker=new Worker(this.file),this.worker.onerror=t=>{},this.worker.onmessage=t=>{let e=t.data;e.key&&(this.E[e.key](e.result),e.erro,delete this.E[e.key])}),this.E[t.key]=e,this.worker.postMessage(this.SETPOST(t)))}}(this);async installCore(t){null!=NengeApp&&NengeApp.Module||(new Function("NengeApp",t.file.CoreJS+";"+t.file.CoreMD5)(this),["CoreFile","Core7z","CoreZip","CoreRar","CoreRarMem"].forEach((e=>{t.file[e]&&"CoreRar"!==e&&(this[e]=URL.createObjectURL(new Blob([t.file[e]])))})),t.file.CoreRar&&(t.file.CoreRar=t.file.CoreRar.replace('"libunrar.js.mem"','"'+this.CoreRarMem+'"'),this.CoreRar=URL.createObjectURL(new Blob([t.file.CoreRar]))));let e=t.file,s=e.cfg,a=this.Module;e.wasmdata&&(this.Module.wasmBinary=e.wasmdata),a.canvas=document.querySelector(".gba-pic"),a.MSG=(t,e)=>this.MSG(t,e),a.runMusic=this.CONFIG["do-music"]||!1,a.MusicMSG=()=>{this.MSG('<button data-btn="startmusic">启动模拟器音乐</button>')},a.onRuntimeInitialized=s=>{e.wasmdata=null,e=null,a.wasmBinary=null,t=null,this.CONFIG.lastgame?this.BtnMap.db.GetRoom(this.CONFIG.lastgame):this.BtnMap.rooms.show()},"undefined"==typeof EmulatorJS?new Function("NengeApp",e.wasmjs+";EmulatorJS(NengeApp.Module);")(this):EmulatorJS(a);let i=a.FS;i.createFolder("/","etc",!0,!0),i.createFolder("/etc","VBA Next",!0,!0),i.mkdir("/shader"),i.syncfs(!0,(function(t){})),i.createFolder("/home/web_user",".config",!0,!0),i.createFolder("/home/web_user/.config","retroarch",!0,!0);for(let t in s)s[t]&&i.writeFile(t,s[t])}AddJs(t,e){let s=document.createElement("script");s.src=t,e&&(s.onload=e),document.body.appendChild(s)}get isRun(){if(this.running)return!0;let t=this.Module&&this.Module.noExitRuntime;return t?this.running=!0:this.BtnMap.rooms.show(),t}get MusicState(){let t=0==this.Module.onRunning&&1==this.Module.runMusic;if(t)return this.BtnMap.startmusic(),t}BtnMap={startmusic:t=>{this.Module.MusicStart(),this.MSG("启动音乐",!0)},do:{settings:t=>{this.RESULT(this.ELM.MENU_HTML)},reload:t=>location.reload(),reset:t=>{this.isRun&&(this.Module.cwrap("system_restart","",[])(),this.BtnMap.closelist())},music:t=>(this.setConfig({"do-music":!this.CONFIG["do-music"]}),this.BtnMap.closelist(),location.reload()),forward:()=>{this.isRun&&(this.CONFIG["do-forward"]=!this.CONFIG["do-forward"],this.Module.cwrap("fast_forward","number",["number"])(this.CONFIG["do-forward"]?1:0),this.BtnMap.closelist())},downscreen:t=>{this.download(this.DATA.SCREEN,this.GetName("png")),this.BtnMap.closelist()},shader:t=>{this.isRun&&(t&&t.target&&t.target.classList.toggle("active"),this.CONFIG["do-shader"]=[],document.querySelectorAll('[data-btn="do-shader"]').forEach((t=>{t.classList.contains("active")&&this.CONFIG["do-shader"].push(t.getAttribute("data-option"))})),this.setConfig({"do-shader":this.CONFIG["do-shader"]}),this.DATA.SetShader(),this.BtnMap.closelist())},getinfo:t=>{fetch("list.html").then((t=>t.arrayBuffer())).then((t=>this.RESULT((new TextDecoder).decode(t))))},sw:t=>{this.CONFIG["do-sw"]?this.BtnMap.sw.clear().then((t=>location.reload())):this.BtnMap.sw.install().then((t=>this.BtnMap.closelist()))},loop:t=>{this.Module.resumeMainLoop(),this.BtnMap.closelist()},hideui:t=>{this.BtnMap.closelist();let e=document.querySelector(".gba-ctrl").classList;e.toggle("hideui"),this.setConfig({"do-hideui":e.contains("hideui")})},record:t=>{if(this.isRun&&this.GameName){if(this.BtnMap.closelist(),!this.Record)return this.setConfig({"do-record":!1}),void this.MSG("<h3>错误</h3>不能录屏<br>当前浏览器不支持<br>MediaRecorder API<br>请停止使用。</h3>");this.CONFIG["do-record"]?(this.setConfig({"do-record":!1}),this.Record.stop()):(this.setConfig({"do-record":!0}),this.MSG("<button data-btn>录屏已开始</button>",!0),this.Record.start())}}},sw:{clear:t=>new Promise(((t,e)=>{"serviceWorker"in navigator?navigator.serviceWorker.getRegistrations().then((e=>{for(let t in e)e[t].unregister();this.setConfig({"do-sw":!1}),caches.delete("NengeApp_VBA").then((e=>t()))})):t()})),install:t=>new Promise(((t,e)=>{"serviceWorker"in navigator?(navigator.serviceWorker.register("sw.js").then((async e=>{this.setConfig({"do-sw":!0}),t();const s=await navigator.serviceWorker.getRegistrations();for(let t in s){let e=s[t];if(e.active){let t=e.active,s=new MessageChannel,a=new CustomEvent("message");s.port1.onmessage=e=>{"install"==e.data&&(t.postMessage=t=>s.port1.postMessage(t),s.port1.onmessage=e=>{t.onmessage&&t.onmessage(e),a.data=e.data,t.dispatchEvent(a)})},t.onmessage=t=>{t.data.message&&this.MSG(`<button data-btn>${t.data.message}</button>`,!0)},t.postMessage("install",[s.port2])}}}),(t=>{})),navigator.serviceWorker.addEventListener("message",(t=>{t.data.message&&this.MSG(`<button data-btn>${t.data.message}</button>`,!0)}))):t()}))},srm:{up:t=>{this.isRun&&(this.BtnMap.closelist(),this.upload((t=>{let e=t=>t instanceof Uint8Array&&(139264==t.length||131072==t.length);if(e(t))return this.DATA.AddSRM(t);if("object"==typeof t)for(let s in t)if(e(t[s])){return this.DATA.AddSRM(t[s]);break}this.MSG("存档文件大小不符合要求被忽略了！"),t=null})))},down:t=>{this.isRun&&(this.BtnMap.closelist(),this.download(this.DATA.SRM,this.GetName("srm")))},down128:t=>{if(!this.isRun)return;this.BtnMap.closelist();let e=new Uint8Array(this.DATA.SRM.subarray(0,131072));this.download(e,this.GetName("srm"))}},key:{key:t=>{this.RESULT(this.ELM.KEY_HTML(this.KEY.KeyCodetoArr(),this.KEY.KeyboardIndex))},gamepad:t=>{this.RESULT(this.ELM.GAMEPAD_HTML(this.KEY.KeyGamePad,this.KEY.KeyGamePadMap,this.KEY.KeyMap))},save:t=>{let e=this.KEY.ELMsetKeyBoard();this.BtnMap.closelist(),this.setConfig({KeyCode:e})},reset:t=>{this.KEY.resetKeyBoard(),this.BtnMap.key.key()}},translate:{load:t=>{if(this.MusicState)return;let e=this.CONFIG.baiduKey;return e&&e.id&&e.key?this.BtnMap.translate.Baidu("POST"):this.BtnMap.translate.show()},save:t=>{let e={id:document.querySelector(".gba-translate-id").value,key:document.querySelector(".gba-translate-key").value,host:document.querySelector(".gba-translate-host").value,from:document.querySelector(".gba-translate-from").value,to:document.querySelector(".gba-translate-to").value};e.id&&e.key&&(this.setConfig({baiduKey:e}),this.BtnMap.closelist())},show:t=>{this.RESULT(this.ELM.BAIDU_HTML(this.CONFIG.baiduKey||{})),document.querySelector(".gba-translate-id").select()},Baidu:(t,e)=>{e=e||{},t=t||"GET";let s,a=new FormData,i=this.CONFIG.baiduKey,n=this.DATA.SCREEN,r={key:i.key,appid:i.id,from:i.from,to:i.to,q:i.q||"",salt:Math.random(),cuid:"APICUID",mac:"mac",version:3,paste:0},o=["mac","cuid","version","paste","key"],h=i.host+"?";for(var l in r)a.append(l,e[l]||r[l]);if("GET"==t)a.append("callback","NengeApp.MSGJSON"),a.append("sign",SparkMD5.hash(a.get("appid")+a.get("salt")+a.get("salt")+a.get("key")));else{o=["q","key"],s=new FormData;let t=SparkMD5.ArrayBuffer.hash(n.buffer);s.append("image",new File([n.buffer],"my.png",{type:"image/png"})),a.append("sign",SparkMD5.hash(a.get("appid")+t+a.get("salt")+a.get("cuid")+a.get("mac")+a.get("key")))}if(o.forEach((t=>a.delete(t))),a=new URLSearchParams(a),"GET"==t)return this.AddJs(h+a);fetch(new Request(h+a,{method:t,body:s})).then((t=>t.json())).then((t=>{let e;t&&t.data&&(e=t.data.sumDst?t.data.sumDst.replace(/\n/g,"<br>"):"错误！没找到可翻译内容"),this.MSG('<div class="gba-translate-show">'+e+"</div>")})).catch((t=>this.MSG("很遗憾!翻译功能要跨域!")))}},cheat:{show:async t=>{if(!this.isRun)return;let e='<div><textarea style="width: 100%;height: 500px;" class="gba-cheats">',s=await this.DB({method:"get",name:this.GameName,db:"info"});s&&s.cheat&&(e+=s.cheat);let a='<button type="button" data-btn="cheat-run">启用</button> | <button type="button" data-btn="cheat-save">保存并启用</button> | <button type="button" data-btn="cheat-stop">暂停</button>';e+="</textarea></div>",this.RESULT(a+e+a)},run:t=>{if(!this.isRun)return;let e=document.querySelector(".gba-cheats").value.split("\n"),s=[];for(let t=0;t<e.length;t++){let a=e[t].trim();-1==a.indexOf("-")&&-1==a.indexOf("#")&&(a=a.replace(/\s+?/g,""),s.push(a))}this.Module._reset_cheat(),this.Module.cwrap("set_cheat","number",["number","number","string"])(0,1,s.join("\\n"))},stop:t=>{this.isRun&&this.Module._reset_cheat()},save:async t=>{this.isRun&&this.DB({method:"update",name:this.GameName,data:{cheat:document.querySelector(".gba-cheats").value},db:"info"}).then((t=>{this.BtnMap.cheat.run()}))}},db:{InsertRoom:(t,e,s)=>new Promise(((a,i)=>{let n=new Date;this.DB({method:"put",data:{name:e,time:n},db:"info"}),this.DB({method:"put",data:{name:e,gba:t,time:n},db:"room"}).then((t=>{s?s(t):a(t)})).catch((t=>i(t)))})),UpdateRoom:t=>new Promise(((e,s)=>{if(!this.isRun||""==this.CONFIG.lastgame)return"function"==typeof t&&t(result),e(!1);let a=new Date,i=this.GameName,n=this.DATA.SCREEN,r=this.DATA.STATE,o=this.DATA.SRM;this.DB({method:"update",name:i,data:{img:n,time:a},db:"info"}).then((t=>{})),this.DB({method:"update",name:i,data:{state:r,srm:o,time:a},db:"room"}).then((s=>{this.MSG(`<h3>${i}</h3><button data-btn="">快照${s?"储存成功":"存储失败!"}</button>`,!0),"function"==typeof t&&t(s),e(s),a=new Date,n=null,r=null,o=null})).catch((t=>s(t)))})),GetInfo:t=>new Promise(((e,s)=>{this.DB({method:"all",orderBy:"time",db:"info"}).then((s=>{t?t(s):e(s)}))})),GetRoom:(t,e)=>{if(t==this.CoreFileName)return this.MSG("核心文件不是游戏文件！");this.DB({method:"get",name:t,db:"room"}).then((t=>{if(!t)return this.BtnMap.rooms.show();if(!e)return this.setConfig({lastgame:t.name}),this.DATA.AddROOM(t.gba,t.srm,t.state,t.name),this.BtnMap.closelist();let s=t.name.toLowerCase().replace(/\.gba/g,"");t.gba&&this.download(t.gba,s+".gba"),t.srm&&this.download(t.srm,s+".srm"),t.state&&this.download(t.state,s+".state")}))},Delete:(t,e,s)=>new Promise(((a,i)=>{this.DB({method:"delete",name:t,db:e}).then((t=>s?s(t):a(t))).catch((t=>i(t)))}))},state:{show:async t=>{if(!this.isRun)return;this.BtnMap.closelist();let e="",s="state",a=await this.DB({method:"get",db:s,name:this.GameName});if(a){let t={};for(let e=0;e<5;e++)a[s+e]&&(t[e]={name:e,title:"位置"+e,img:a[s+"img"+e],time:a[s+"time"+e]});e+=this.ELM.ROOMS_LIST(t,s)}else e+="<div><h3>本游戏没有S/L记录！</h3></div>";this.RESULT(e)},delete:t=>{},clear:t=>{this.DB({method:"delete",name:this.GameName,db:"state"}).then((t=>{this.BtnMap.closelist()}))},allclear:t=>{this.DB({method:"clear",db:"state"}).then((t=>{this.BtnMap.closelist()}))},down:t=>{if(!this.isRun)return;let e=t.target.getAttribute("data-keyname");if(null==e)return this.BtnMap.closelist(),void this.download(this.DATA.STATE,this.GetName("state"));this.DB({method:"get",name:this.GameName,db:"state"}).then((t=>{if(!t)return;let s=t["state"+e];s&&(this.download(s,this.GetName("state")),s=null),this.BtnMap.closelist()}))},load:t=>{if(!this.isRun)return;if(this.MusicState)return;let e=this.CONFIG.stateKey;if(t){let s=t.target;null!=s.getAttribute("data-keyname")&&(e=s.getAttribute("data-keyname"))}this.DB({method:"get",name:this.GameName,db:"state"}).then((t=>{if(!t)return;let s=t["state"+e];s&&(this.DATA.STATE=s,s=null),this.BtnMap.closelist()}))},save:t=>{if(!this.isRun)return;if(this.MusicState)return;let e={};return e["state"+this.CONFIG.stateKey]=this.DATA.STATE,e["stateimg"+this.CONFIG.stateKey]=this.DATA.SCREEN,e["statetime"+this.CONFIG.stateKey]=new Date,this.BtnMap.closelist(),this.DB({method:"update",name:this.GameName,data:e,db:"state"}).then((t=>{t?(this.BtnMap.closelist(),this.MSG("即时存档保存成功",!0)):(e.name=this.GameName,this.DB({method:"put",data:e,db:"state"}).then((t=>{this.MSG("即时存档保存成功",!0),this.BtnMap.closelist()})))}))},up:t=>{this.isRun&&(this.BtnMap.closelist(),this.upload((t=>{if(t instanceof Uint8Array)this.DATA.STATE=t;else if("object"==typeof t)for(let e in t)if(t[e]instanceof Uint8Array){this.DATA.STATE=t[e];break}})))},switch:t=>{this.setConfig({stateKey:++this.CONFIG.stateKey%5}),this.MSG(`<button data-btn>当前即时存档位置为:${this.CONFIG.stateKey}</button">`,!0)}},rooms:{show:t=>{this.BtnMap.db.GetInfo((t=>{this.RESULT(this.ELM.ROOMS_LIST(t))}))},load:t=>{if(!this.MusicState){if(t&&t.target&&(t=(t=t.target).getAttribute("data-keyname")),t==this.CoreFileName)return this.MSG("核心文件不是游戏文件！");t&&this.GameName!=t&&(this.GameName?this.BtnMap.db.UpdateRoom().then((e=>this.BtnMap.db.GetRoom(t))):this.BtnMap.db.GetRoom(t))}},delete:async t=>{let e=t.target.getAttribute("data-keyname");this.BtnMap.db.Delete(e,"room"),this.BtnMap.db.Delete(e,"info",(t=>{e==this.GameName&&(this.setConfig({lastgame:""}),location.reload()),document.querySelector(`.gba-roomslist[data-keyname="${e}"`).remove()}))},save:t=>{this.BtnMap.db.UpdateRoom().then((t=>this.BtnMap.closelist()))},down:t=>{let e=t.target.getAttribute("data-keyname");if(e==this.CoreFileName)return location.href="https://github.com/nenge123/vba_next_wasm";this.BtnMap.db.GetRoom(e,!0)},upload:async t=>{this.upload(((t,e)=>{let s=(t,e)=>{this.BtnMap.db.InsertRoom(t,e).then((t=>{a||this.BtnMap.rooms.show()}))},a="";if(t instanceof Uint8Array)150!=t[178]?a+=this.ELM.NOTGBA_HTML(e):s(t,e),t=null;else if("object"==typeof t){for(let e in t)t[e]instanceof Uint8Array&&(150!=t[e][178]?a+=this.ELM.NOTGBA_HTML(e):s(t[e],e));t=null}a&&(this.BtnMap.closelist(),this.MSG(a))}))}},closelist:t=>{let e=document.querySelector(".gba-list");e.style.cssText="",this.ListResultHide&&e.classList.remove("hideTitle"),document.querySelector(".gba-result").innerHTML=""},openlist:t=>{let e=document.querySelector(".gba-list");e.style.cssText="top:0px",!0===t&&(this.ListResultHide=!0,e.classList.add("hidetitle"))},closemsg:t=>{this.BtnMap.CloseMsg()},CloseMsg:t=>{document.querySelector(".gba-msg").style.display=t?"":"none"}};RESULT(t,e){let s=document.querySelector(".gba-result");s.innerHTML=t,this.BtnMap.openlist(e),s=null}MSG(t,e){clearTimeout(this.Timer.msg),document.querySelector(".gba-msg").innerHTML=t,this.BtnMap.CloseMsg(!0),1==e&&(this.Timer.msg=setTimeout((t=>this.BtnMap.CloseMsg()),1500))}MSGJSON(t,e){return this.MSG("<pre>"+JSON.stringify(t,null,4)+"</pre>",e)}UpLoad(t){}upload(t){}download(t,e,s){let a=document.createElement("a");a.href=URL.createObjectURL(new Blob(t instanceof Array?t:[t],s||{type:"application/octet-stream"})),a.download=e||this.GameName,a.click(),a=null}GetName(t){return this.GameName||(this.GameName="未知游戏.gba"),/\.gba$/.test(this.GameName)||(this.GameName+=".gba"),t?this.GameName.replace(".gba","."+t):this.GameName}async initDB(){let t=await this.DB({method:"get",name:this.CoreFileName,db:"info"});if(t&&t.file.version==this.version)return this.installCore(t);let e=0,s=this,a=await fetch(this.CoreFile+"?"+Math.random()),i=`<h3>网络错误,或者无法下载：${this.CoreFile}</h3>`,n=e=>{this.MSG(e),t&&this.installCore(t)},r=a.headers.get("Content-Length")||"",o=a.headers.get("Content-Type")||"";if(404==a.status|o.includes("text/html; charset="))return n(`${i}<p><button data-btn>错误代码: ${a.status}</button></p><p><button data-btn>错误代码: ${a.statusText}</button></p><p>尝试读取旧版本数据.</p>`);const h=a.body.getReader(),l=new ReadableStream({start(t){let a=i=>{h.read().then((({done:i,value:n})=>{if(i)return t.close(),void(a=null);e+=n.length,s.MSG("<h3>请稍等！</h3>"+s.CoreFile+'<br><button data-btn="">已下载: '+Math.ceil(e/r*100)+"% 速度："+Math.ceil(n.length/1024)+"KB</button>"),t.enqueue(n),a()}))};a()}});let d=await new Response(l).arrayBuffer(),m=await this.CheckFile(d);if(this.MSG("解压完成"),!m||m instanceof Uint8Array)return n(`${i}<p><button data-btn>错误原因: 无法解压</button></p><p>尝试读取旧版本数据.</p>`);t=null;let u=["js","cfg","glsl","glslp"],c={file:{cfg:{},version:s.version},name:this.CoreFileName};for(var p in m){let t=p.split(".").pop(),e=p.split("/").pop(),s=new Uint8Array(m[p]);if(u.includes(t)){let a=(g=s,(new TextDecoder).decode(g));"retroarch.min.js"==e?c.file.wasmjs=a:"extract7z.min.js"==e?c.file.Core7z=a:"jszip.js"==e?c.file.CoreZip=a:"libunrar.js"==e?c.file.CoreRar=a:"NengeApp.class.min.js"==e?c.file.CoreJS=a:"spark-md5.min.js"==e?c.file.CoreMD5=a:"js"!==t&&(c.file.cfg[p]=a)}else"retroarch.wasm"==e?c.file.wasmdata=s:"retroarch.js.mem"==e?c.file.memdata=s:"libunrar.js.mem"==e?c.file.CoreRarMem=s:"icon.png"==e&&(c.img=s);m[p]=null}var g;c.time=new Date,m=null;await this.DB({method:"put",data:c,db:"info"});this.MSG("保存完毕"),this.installCore(c)}CheckFile(t,e){return new Promise(((s,a)=>{if(!t||0==t.length)return a();let i=new Uint8Array(t),n={"504B0304":"unZip",52617221:"unRAR","377ABCAF":"un7z"}[Array.from(i.subarray(0,4)).map((t=>(t<16?"0":"")+t.toString(16))).join("").toUpperCase()];if(t=null,n)return this[n](i,e).then((t=>s(t)));s(i,e)}))}un7z(t,e){return new Promise(((e,s)=>{let a=new Worker(this.Core7z),i={};a.onmessage=t=>{t.data.data?i[t.data.file]=t.data.data:1==t.data.t&&e(i)},a.postMessage(t)}))}unZip(t,e,s){return new Promise(((e,s)=>{let a=new Worker(this.CoreZip);return a.onmessage=t=>{e(t.data)},a.postMessage(t),t=null,{}}))}unRAR(t,e,s){return e=e||"test.rar",new Promise(((a,i)=>{let n=new Worker(this.CoreRar);n.onmessage=e=>{let s=e.data.ls,i={};for(let t in s)"dir"!=s[t].type&&s[t].fileContent&&(i[s[t].fullFileName]=s[t].fileContent);a(i),t=null,n.terminate()},n.onerror=s=>{"Uncaught Missing password"==s.message||"Uncaught File CRC error"==s.message?(this.RESULT(this.ELM.RAR_HTML(s.message),!0),this.BtnMap.unrar=s=>{let a=document.querySelector(".gba-rar-password");a.value&&(this.BtnMap.unrar=null,this.BtnMap.closelist(),n.postMessage({data:[{name:e,content:t}],password:a.value}))},this.BtnMap.exitrar=t=>{n.terminate(),this.BtnMap.closelist()}):(this.MSG(s.message||"rar发生未知错误,目前支持RAR4的解压!"),n.terminate())},n.postMessage({data:[{name:e,content:t}],password:s})}))}get Record(){if(null!=this._Record)return this._Record;let t;if(["video/webm; codecs=h264","video/webm; codecs=vp9","video/webm; codecs=vp8","video/webm; codecs=vp9.0","video/webm; codecs=vp8.0","video/webm; codecs=avc1"].forEach((e=>{!t&&MediaRecorder.isTypeSupported(e)&&(t=e)})),!t)return void(this._Record=!1);let e=new MediaRecorder(this.Module.canvas.captureStream(30),{mimeType:t});if(e&&e.stream)return e.BLOBdata=[],e.ondataavailable=t=>{e.BLOBdata.push(t.data)},e.onstop=t=>{e.BLOBdata.length<1||(this.download(e.BLOBdata,this.GetName("webm"),{type:"video/webm"}),e.BLOBdata=[])},this._Record=e,this._Record;this._Record=!1}setConfig(t){if(t){let e=localStorage.getItem("vba-next-config");e=e?JSON.parse(e):this.CONFIG;for(let s in t)e[s]=t[s];localStorage.setItem("vba-next-config",JSON.stringify(e)),this.CONFIG=e}return this.CONFIG}};